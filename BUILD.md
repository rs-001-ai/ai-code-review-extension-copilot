# Build & Publish Guide

## Prerequisites

- Node.js 16+ and npm
- TypeScript (`npm install -g typescript`)
- Azure DevOps Extension CLI (`npm install -g tfx-cli`)
- A Visual Studio Marketplace publisher account

## Build Steps

### 1. Install dependencies

```bash
cd ai-code-review-extension-copilot
npm install

cd tasks/AICodeReviewTask
npm install
```

### 2. Compile TypeScript

```bash
# From the repo root
npm run build
```

This produces `tasks/AICodeReviewTask/index.js` from `index.ts`.

### 3. Package the extension

```bash
npm run package
# or
npx tfx-cli extension create --manifest-globs vss-extension.json
```

This creates a `.vsix` file (e.g., `RachitSinghal.copilot-code-review-bot-2.0.19.vsix`).

### 4. Publish to Marketplace

```bash
npx tfx-cli extension publish --vsix RachitSinghal.copilot-code-review-bot-2.0.19.vsix --share-with yourorg
```

Or publish and share in one step:

```bash
npx tfx-cli extension publish --manifest-globs vss-extension.json --token YOUR_MARKETPLACE_PAT --share-with yourorg
```

## Testing Locally

### Test the Copilot CLI directly

```bash
# Install Copilot CLI
npm install -g @github/copilot@latest

# Test authentication
export COPILOT_GITHUB_TOKEN="github_pat_YOUR_TOKEN_HERE"
copilot --model claude-sonnet-4.5 -p "Review: def add(a,b): return a+b" --allow-all-tools
```

### Test the GitHub Models API

```bash
python3 test_api.py github_pat_YOUR_TOKEN_HERE
```

This tests both the `models.github.ai/inference` endpoint and the Copilot CLI.

### Test the Python script directly

```bash
# Set required environment variables
export SYSTEM_COLLECTIONURI="https://dev.azure.com/yourorg/"
export SYSTEM_TEAMPROJECT="YourProject"
export BUILD_REPOSITORY_NAME="YourRepo"
export SYSTEM_PULLREQUEST_PULLREQUESTID="123"
export SYSTEM_ACCESSTOKEN="your-ado-pat"
export INPUT_GITHUB_PAT="github_pat_YOUR_TOKEN_HERE"
export INPUT_COPILOT_MODEL="claude-sonnet-4.5"
export INPUT_DEBUG="true"
export GH_TOKEN="github_pat_YOUR_TOKEN_HERE"
export GITHUB_TOKEN="github_pat_YOUR_TOKEN_HERE"
export COPILOT_GITHUB_TOKEN="github_pat_YOUR_TOKEN_HERE"

python3 tasks/AICodeReviewTask/review_code.py
```

### Test with a mock diff

```python
# test_review.py
import os
os.environ["INPUT_GITHUB_PAT"] = "github_pat_YOUR_TOKEN_HERE"
os.environ["GH_TOKEN"] = "github_pat_YOUR_TOKEN_HERE"
os.environ["GITHUB_TOKEN"] = "github_pat_YOUR_TOKEN_HERE"
os.environ["COPILOT_GITHUB_TOKEN"] = "github_pat_YOUR_TOKEN_HERE"
os.environ["INPUT_DEBUG"] = "true"

from tasks.AICodeReviewTask.review_code import (
    install_copilot_cli, run_copilot_review, parse_review_response, format_review_comment
)

test_diff = """
--- a/src/auth.py
+++ b/src/auth.py
@@ -10,6 +10,10 @@
 def authenticate(username, password):
-    query = "SELECT * FROM users WHERE name='" + username + "'"
+    query = f"SELECT * FROM users WHERE name='{username}'"
     cursor.execute(query)
"""

raw = run_copilot_review(test_diff)
review = parse_review_response(raw)
comment = format_review_comment(review)
print(comment)
```

## Project Structure

```
ai-code-review-extension-copilot/
├── README.md                              # User documentation
├── BUILD.md                               # This file - build & publish guide
├── LICENSE                                # MIT License
├── package.json                           # Root package config
├── vss-extension.json                     # Azure DevOps extension manifest
├── test_api.py                            # Local API & CLI test script
├── images/
│   └── icon.png                           # Extension icon
└── tasks/
    └── AICodeReviewTask/
        ├── task.json                      # Task definition & inputs
        ├── index.ts                       # TypeScript entry (bridges ADO → Python)
        ├── index.js                       # Compiled JS (generated by tsc)
        ├── tsconfig.json                  # TypeScript config
        ├── review_code.py                 # Main review logic (Python)
        ├── code-review-skill/             # Skill-based prompt system
        │   ├── SKILL.md                   # Core review guidelines & output format
        │   └── references/
        │       ├── python.md              # Python-specific review rules
        │       ├── javascript.md          # JS/TS-specific review rules
        │       ├── csharp.md              # C#/.NET-specific review rules
        │       ├── java.md                # Java/Kotlin-specific review rules
        │       ├── go.md                  # Go-specific review rules
        │       ├── rust.md                # Rust-specific review rules
        │       ├── cpp.md                 # C/C++-specific review rules
        │       ├── frontend.md            # Frontend framework rules (React, Vue, Angular)
        │       ├── backend.md             # Backend framework rules (Express, Spring, ASP.NET)
        │       ├── security.md            # Security review (OWASP Top 10)
        │       ├── architecture.md        # Architecture review (SOLID, patterns)
        │       └── performance.md         # Performance review (complexity, memory)
        ├── package.json                   # Task dependencies
        └── node_modules/                  # Task node_modules (bundled in VSIX)
```

## Key Components

### `index.ts` → `index.js`

The TypeScript entry point that bridges Azure DevOps task inputs to the Python script. It:
- Reads task inputs (githubPat, copilotModel, etc.)
- Sets environment variables (INPUT_GITHUB_PAT, GH_TOKEN, COPILOT_GITHUB_TOKEN, etc.)
- Executes `review_code.py` via Python subprocess

### `review_code.py`

The main review engine. Flow:
1. Fetches PR diff via `git diff` or Azure DevOps REST API
2. Detects languages/frameworks from diff file extensions and content
3. Builds skill-based prompt (SKILL.md + language + framework + security/arch/perf)
4. Authenticates and runs GitHub Copilot CLI (`copilot --model claude-sonnet-4.5 --allow-all-tools -p "prompt"`)
5. Falls back to GitHub Models API (`models.github.ai/inference` with `openai/gpt-5`) if CLI fails
6. Parses JSON review response (with truncation repair and regex fallback)
7. Posts formatted review comment to PR via Azure DevOps REST API

### `code-review-skill/`

Skill files that provide specialized review context. Automatically loaded based on:
- **File extensions** in the diff (e.g., `.cs` → `csharp.md`)
- **Framework patterns** in the diff content (e.g., `react` → `frontend.md`)
- **Cross-cutting concerns** always loaded: `security.md`, `architecture.md`, `performance.md`

## Key Changes: v1 (OpenAI) → v2 (Copilot)

| Component | v1 | v2 |
|-----------|-----|-----|
| AI Backend | OpenAI REST API | GitHub Copilot CLI + Models API fallback |
| Auth | `OPENAI_API_KEY` | Fine-Grained GitHub PAT (`github_pat_*`) |
| Models | `gpt-4`, `gpt-3.5-turbo` | Claude 4.5, GPT-5.x, Gemini 3 via Copilot |
| Default Model | `gpt-4o` | `claude-sonnet-4.5` |
| Cost | Per-token OpenAI billing | Included in Copilot subscription (Premium requests) |
| CLI | None | Copilot CLI auto-installed via npm |
| Prompt System | Single hardcoded prompt | Skill-based with 13 specialized files |
| Context Limit | 8K tokens (GPT-4o) | 200K tokens (Claude Sonnet 4.5) |
| Diff Limit | 60K chars | 400K chars |
| Fallback | None | GitHub Models API with GPT-5 |
| Auth Method | API key | Fine-Grained PAT + COPILOT_GITHUB_TOKEN env var |

## Version History

| Version | Changes |
|---------|---------|
| 2.0.19 | Increase diff limit to 400K chars for Claude's 200K context |
| 2.0.18 | Enable skill-based review prompts with language/framework detection |
| 2.0.17 | Fix Copilot CLI auth: force gh config write, add diagnostics |
| 2.0.16 | Prioritize npm install for Copilot CLI, add COPILOT_GITHUB_TOKEN |
| 2.0.15 | Add Copilot CLI support with --allow-all-tools flag |
| 2.0.10 | Switch to GitHub Models API, add Claude/GPT-5 models |
| 2.0.0 | Major rewrite: OpenAI → GitHub Copilot architecture |
| 1.x | Original OpenAI API-based version |
