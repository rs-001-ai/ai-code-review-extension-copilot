# Build & Publish Guide

## Prerequisites

- Node.js 16+ and npm
- TypeScript (`npm install -g typescript`)
- Azure DevOps Extension CLI (`npm install -g tfx-cli`)
- A Visual Studio Marketplace publisher account

## Build Steps

### 1. Install dependencies

```bash
cd ai-code-review-extension
npm install

cd tasks/AICodeReviewTask
npm install
```

### 2. Compile TypeScript

```bash
cd tasks/AICodeReviewTask
tsc -p tsconfig.json
```

This produces `index.js` from `index.ts`.

### 3. Package the extension

```bash
cd ../../  # back to repo root
tfx extension create --manifest-globs vss-extension.json
```

This creates a `.vsix` file.

### 4. Publish to Marketplace

```bash
tfx extension publish --manifest-globs vss-extension.json --token YOUR_PAT
```

## Testing Locally

### Test the Python script directly

```bash
# Set required environment variables
export SYSTEM_COLLECTIONURI="https://dev.azure.com/yourorg/"
export SYSTEM_TEAMPROJECT="YourProject"
export BUILD_REPOSITORY_NAME="YourRepo"
export SYSTEM_PULLREQUEST_PULLREQUESTID="123"
export SYSTEM_ACCESSTOKEN="your-ado-pat"
export INPUT_GITHUB_PAT="your-github-pat"
export INPUT_COPILOT_MODEL="claude-sonnet-4.5"
export INPUT_DEBUG="true"
export GH_TOKEN="your-github-pat"

python3 tasks/AICodeReviewTask/review_code.py
```

### Test with a mock diff

Create a test script that pipes a diff directly:

```python
# test_review.py
import os
os.environ["INPUT_GITHUB_PAT"] = "your-github-pat"
os.environ["GH_TOKEN"] = "your-github-pat"
os.environ["INPUT_DEBUG"] = "true"

from tasks.AICodeReviewTask.review_code import (
    install_copilot_cli, run_copilot_review, parse_review_response, format_review_comment
)

test_diff = """
--- a/src/auth.py
+++ b/src/auth.py
@@ -10,6 +10,10 @@
 def authenticate(username, password):
-    query = "SELECT * FROM users WHERE name='" + username + "'"
+    query = f"SELECT * FROM users WHERE name='{username}'"
     cursor.execute(query)
"""

cli = install_copilot_cli()
raw = run_copilot_review(test_diff, cli)
review = parse_review_response(raw)
comment = format_review_comment(review)
print(comment)
```

## Project Structure

```
ai-code-review-extension/
├── README.md                          # Main documentation
├── BUILD.md                           # This file
├── LICENSE                            # MIT License
├── package.json                       # Root package config
├── vss-extension.json                 # Azure DevOps extension manifest
├── images/
│   └── icon.png                       # Extension icon
└── tasks/
    └── AICodeReviewTask/
        ├── task.json                  # Task definition & inputs
        ├── index.ts                   # TypeScript entry (bridges ADO → Python)
        ├── index.js                   # Compiled JS (generated by tsc)
        ├── tsconfig.json              # TypeScript config
        ├── review_code.py             # Main review logic (Python)
        └── node_modules/              # Task dependencies
```

## Key Changes from v1 (OpenAI) to v2 (Copilot)

| Component | v1 | v2 |
|-----------|-----|-----|
| AI Backend | OpenAI REST API | GitHub Copilot CLI / Models API |
| Auth | `OPENAI_API_KEY` | GitHub PAT with Copilot permission |
| Models | `gpt-4`, `gpt-3.5-turbo` | Claude, GPT-5.x, Gemini via Copilot |
| Cost | Per-token OpenAI billing | Included in Copilot subscription |
| CLI Dependency | None | Copilot CLI (auto-installed) |
| Fallback | None | `gh api models/chat/completions` |
